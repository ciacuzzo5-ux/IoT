import network
import machine
import esp
import gc
from machine import Pin

# 1) DISABILITAZIONE DEBUG E PULIZIA RAM
esp.osdebug(None)
gc.collect()

# 2) CONFIGURAZIONE WI-FI
WIFI_NAME = 'iPhone di Chiara'
WIFI_PASSWORD = '23032004'

def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    wlan.connect(WIFI_NAME, WIFI_PASSWORD)

    while not wlan.isconnected():
        pass
    
    return wlan

WLAN = connect_wifi()

# 3) CONFIGURAZIONE MQTT (SOLO COSTANTI)
MQTT_BROKER = "172.19.159.125"
MQTT_CLIENT_ID = "esp32_caveau"

# Topic PUB
MQTT_TOPIC_STATUS = b"caveau/status"
MQTT_TOPIC_EVENTS = b"caveau/events"
MQTT_TOPIC_COMMAND = b"caveau/cmd"


# 4) COSTANTI DEL PROGETTO (SENZA LOGICA)
SECRET_CODE = "2004"
UNLOCK_DOOR = 10         # tempo apertura porta (sec)

# Stato del caveau
STATE_ARMED = 0          # sensori attivi
STATE_UNLOCKED = 1       # codice corretto → porta aperta
STATE_ALARM = 2          # allarme attivo

# Soglia movimento accelerometro
MOVEMENT_THRESHOLD = 8000

# 5) PIN HARDWARE (SOLO DEFINIZIONE)

# LED e buzzer
LED_RED_PIN    = 15
LED_GREEN_PIN  = 2
LED_BLUE_PIN   = 4
BUZZER_PIN     = 5

# Servo
SERVO_PIN = 18

# Tastierino (solo pin — nessuna logica)
ROWS_PINS = [27, 14, 12, 13]
COLS_PINS = [26, 25, 33, 32]

# Sensori
# Sensore TCRT5000
IR_SENSOR_PIN = 14

# Sensore HCSR04
PIN_TRIG = 19
PIN_ECHO = 18

#Oled e MPU6050
I2C_SDA = 21
I2C_SCL = 22

#Logo da mostrare
logo = bytearray([
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x20, 0x01, 0xfc, 0x06, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x07, 0xfc, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x1c, 0x03, 0x80, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x98, 0x01, 0x80, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x1c, 0x1e, 0x19, 0xff, 0xff, 0x80, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x0f, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0xe0, 0xc0, 0x0c, 0x00, 0x00, 0x30, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0xc3, 0x83, 0x04, 0x1f, 0x80, 0x30, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x03, 0x06, 0x0c, 0x07, 0xe1, 0x80, 0x60, 0x00, 0x60, 0x40, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x06, 0x0c, 0x38, 0x1c, 0x01, 0x80, 0x3c, 0x0c, 0x38, 0x60, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0c, 0x00, 0x78, 0x00, 0x01, 0x80, 0x07, 0x07, 0x0c, 0x30, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x18, 0x01, 0x8c, 0x00, 0xff, 0xff, 0x01, 0xc1, 0x86, 0x18, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x18, 0x03, 0x06, 0x00, 0x80, 0x03, 0x80, 0xf0, 0xc3, 0x18, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0e, 0x06, 0x03, 0x00, 0x00, 0x01, 0x80, 0xf8, 0x61, 0xe0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x03, 0x8c, 0x01, 0x8c, 0x01, 0xf3, 0x01, 0x8c, 0x30, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x02, 0x78, 0x01, 0x87, 0xc0, 0x0f, 0x83, 0x86, 0x18, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x06, 0x30, 0x03, 0x07, 0x07, 0xe0, 0xe6, 0xc3, 0x38, 0x60, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0c, 0x21, 0x06, 0x0c, 0x7f, 0xfe, 0x3c, 0x61, 0xe0, 0x30, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0c, 0x63, 0x0c, 0x01, 0xff, 0xff, 0xc0, 0x30, 0xc0, 0x30, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x18, 0x42, 0x18, 0x07, 0xff, 0xff, 0xe0, 0x18, 0x40, 0x18, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x18, 0xc6, 0x10, 0x0f, 0xff, 0xff, 0xf0, 0x00, 0x60, 0x18, 0x40, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x10, 0x84, 0x31, 0x9f, 0xff, 0xff, 0xfd, 0x80, 0x20, 0x08, 0x40, 0x00, 0x00, 
0x00, 0x00, 0x06, 0x31, 0x8c, 0x61, 0x3f, 0xf8, 0x1f, 0xff, 0x00, 0x30, 0x00, 0x60, 0x00, 0x00, 
0x00, 0x00, 0x06, 0x31, 0x8c, 0x63, 0x7f, 0xf0, 0x0f, 0xfe, 0x00, 0x30, 0x80, 0x60, 0x00, 0x00, 
0x00, 0x00, 0x06, 0x30, 0x08, 0x42, 0x7f, 0xf0, 0x0f, 0xfe, 0x0e, 0x00, 0x80, 0x60, 0x00, 0x00, 
0x00, 0x00, 0x04, 0x20, 0x08, 0x42, 0x7f, 0xf0, 0x0f, 0xff, 0x7b, 0x00, 0xc0, 0x20, 0x00, 0x00, 
0x00, 0x00, 0x04, 0x20, 0x18, 0xc6, 0xff, 0xf0, 0x0f, 0xff, 0x03, 0x00, 0xc0, 0x20, 0x00, 0x00, 
0x00, 0x00, 0x04, 0x20, 0x18, 0xc4, 0xff, 0xfc, 0x3f, 0xff, 0x03, 0x00, 0xc0, 0x20, 0x00, 0x00, 
0x00, 0x00, 0x04, 0x20, 0x18, 0xc4, 0xff, 0xfc, 0x3f, 0xff, 0x03, 0x00, 0xc0, 0x20, 0x00, 0x00, 
0x00, 0x00, 0x04, 0x20, 0x18, 0xc6, 0xff, 0xfc, 0x3f, 0xff, 0x03, 0x00, 0xc0, 0x20, 0x00, 0x00, 
0x00, 0x00, 0x04, 0x20, 0x08, 0xc2, 0x7f, 0xfc, 0x3f, 0xff, 0x7f, 0x00, 0x80, 0x20, 0x00, 0x00, 
0x00, 0x00, 0x06, 0x30, 0x0f, 0x82, 0x7f, 0xfc, 0x3f, 0xfe, 0x0f, 0xff, 0xc0, 0x60, 0x00, 0x00, 
0x00, 0x00, 0x06, 0x31, 0x80, 0x03, 0x3f, 0xfc, 0x3f, 0xfe, 0x06, 0x01, 0xff, 0xe0, 0x00, 0x00, 
0x00, 0x00, 0x06, 0x01, 0x80, 0x01, 0x3f, 0xfe, 0x7f, 0xfc, 0x06, 0x01, 0x80, 0x60, 0x00, 0x00, 
0x00, 0x00, 0x02, 0x00, 0x80, 0x01, 0x9f, 0xff, 0xff, 0xf9, 0x0c, 0x01, 0x00, 0x40, 0x00, 0x00, 
0x00, 0x00, 0x03, 0x00, 0xc0, 0x03, 0x8f, 0xff, 0xff, 0xf3, 0x08, 0x03, 0x00, 0xc0, 0x00, 0x00, 
0x00, 0x00, 0x03, 0x00, 0x40, 0x1c, 0x07, 0xff, 0xff, 0xe6, 0x08, 0x02, 0x00, 0xc0, 0x00, 0x00, 
0x00, 0x00, 0x01, 0x80, 0x60, 0xe0, 0x01, 0xff, 0xff, 0x9c, 0x00, 0x86, 0x00, 0x80, 0x00, 0x00, 
0x00, 0x00, 0x01, 0x80, 0x33, 0x80, 0x0c, 0x7f, 0xfe, 0x38, 0x01, 0x8c, 0x01, 0x80, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xc0, 0x1c, 0x00, 0x03, 0x80, 0x01, 0xcc, 0x03, 0x0c, 0x03, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0xc0, 0x18, 0x00, 0x40, 0xfc, 0x03, 0x06, 0x06, 0x00, 0x83, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x63, 0x0c, 0x01, 0xf0, 0x03, 0x80, 0x03, 0x0c, 0x00, 0x86, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x3f, 0x86, 0x03, 0x1c, 0x01, 0x80, 0x00, 0xf8, 0x01, 0x8c, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x18, 0xc3, 0x06, 0x03, 0xc1, 0x83, 0x80, 0xe0, 0x03, 0x0c, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x18, 0x70, 0xc0, 0x00, 0x3f, 0xfc, 0x01, 0x80, 0x06, 0x18, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0c, 0x38, 0x60, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x0c, 0x30, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x06, 0x0c, 0x78, 0x00, 0x00, 0x00, 0x78, 0x0e, 0x30, 0x60, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x03, 0x07, 0xce, 0x03, 0xf8, 0x1f, 0xe0, 0x03, 0x60, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0xc3, 0x83, 0xc0, 0x0f, 0xf0, 0x30, 0x03, 0xc3, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x60, 0xe0, 0x70, 0x00, 0x00, 0x10, 0x07, 0xc6, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x38, 0x38, 0x1f, 0x80, 0x01, 0xf0, 0x1c, 0x7c, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x08, 0x0e, 0x00, 0xff, 0xff, 0x00, 0x70, 0x30, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x03, 0xc0, 0xe0, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x3e, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
])

print("[BOOT] Inizializzazione completata.")